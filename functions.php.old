<?php
/**
 * Happy Turtle FSE Theme Functions
 */

// Add theme support
function happyturtle_fse_setup() {
    // Add support for block styles
    add_theme_support('wp-block-styles');

    // Add support for full and wide align images
    add_theme_support('align-wide');

    // Add support for editor styles
    add_theme_support('editor-styles');

    // Add support for responsive embedded content
    add_theme_support('responsive-embeds');

    // Add support for custom logo
    add_theme_support('custom-logo', array(
        'height' => 100,
        'width' => 100,
        'flex-height' => true,
        'flex-width' => true,
    ));

    // Add support for post thumbnails
    add_theme_support('post-thumbnails');
}
add_action('after_setup_theme', 'happyturtle_fse_setup');

// Enqueue styles and scripts
function happyturtle_fse_styles() {
    // Main theme style
    wp_enqueue_style(
        'happyturtle-fse-style',
        get_template_directory_uri() . '/assets/style.css',
        array(),
        '3.0.0'
// Turtle animation CSS    wp_enqueue_style(        'happyturtle-turtle-animation',        get_template_directory_uri() . '/assets/css/turtle-animation.css',        array('happyturtle-fse-style'),        '1.0.0'    );    // Three.js library (CDN r128)    wp_enqueue_script(        'threejs',        'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js',        array(),        '0.128.0',        true    );    // GLTFLoader for Three.js    wp_enqueue_script(        'threejs-gltf-loader',        'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js',        array('threejs'),        '0.128.0',        true    );
    );

    // Splash screen script
    wp_enqueue_script(
        'happyturtle-splash',
        get_template_directory_uri() . '/assets/splash.js',
        array(),
        '2.2.0',
        true
    );

    // Scroll animations script
    wp_enqueue_script(
        'happyturtle-scroll-animations',
        get_template_directory_uri() . '/assets/scroll-animations.js',
        array(),
        '1.0.0',
        true
// Turtle animation script (depends on Three.js and GLTFLoader)    wp_enqueue_script(        'happyturtle-turtle-animation',        get_template_directory_uri() . '/assets/js/turtle-animation.js',        array('threejs', 'threejs-gltf-loader'),        '1.0.0',        true    );    // Turtle animation CSS    wp_enqueue_style(        'happyturtle-turtle-animation',        get_template_directory_uri() . '/assets/css/turtle-animation.css',        array('happyturtle-fse-style'),        '1.0.0'    );    // Three.js library (CDN r128)    wp_enqueue_script(        'threejs',        'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js',        array(),        '0.128.0',        true    );    // GLTFLoader for Three.js    wp_enqueue_script(        'threejs-gltf-loader',        'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js',        array('threejs'),        '0.128.0',        true    );
    );

    // Pass theme URL to JavaScript
    // Also pass to turtle animation script
    wp_localize_script('happyturtle-turtle-animation', 'htbData', array(
        'themeUrl' => get_template_directory_uri()
    ));
    wp_localize_script('happyturtle-splash', 'htbData', array(
        'themeUrl' => get_template_directory_uri()
    ));
}
add_action('wp_enqueue_scripts', 'happyturtle_fse_styles');

// Register pattern categories
function happyturtle_fse_pattern_categories() {
    register_block_pattern_category(
        'happyturtle',
        array(
            'label' => __('Happy Turtle', 'happyturtle-fse'),
            'description' => __('Happy Turtle custom patterns', 'happyturtle-fse'),
        )
    );

    register_block_pattern_category(
        'happyturtle-sections',
        array(
            'label' => __('Happy Turtle Sections', 'happyturtle-fse'),
            'description' => __('Complete section layouts', 'happyturtle-fse'),
        )
    );
}
add_action('init', 'happyturtle_fse_pattern_categories');

// Dynamic copyright year shortcode
function happyturtle_copyright_year() {
    $current_year = date('Y');
    if ($current_year > 2023) {
        return '2023-' . $current_year;
    }
    return '2023';
}
add_shortcode('copyright_year', 'happyturtle_copyright_year');

// Allow 3D model file uploads
function happyturtle_allow_3d_uploads($mime_types) {
    $mime_types['glb'] = 'model/gltf-binary';
    $mime_types['gltf'] = 'model/gltf+json';
    $mime_types['usdz'] = 'model/vnd.usdz+zip';
    $mime_types['fbx'] = 'application/octet-stream';
    return $mime_types;
}
add_filter('upload_mimes', 'happyturtle_allow_3d_uploads');

// Increase upload size limit
@ini_set('upload_max_filesize', '64M');
@ini_set('post_max_size', '64M');
@ini_set('max_execution_time', '300');

// Enqueue splash screen on login page
function happyturtle_login_scripts() {
    wp_enqueue_style('happyturtle-splash-style', get_template_directory_uri() . '/assets/style.css', array(), '3.0.0');
    wp_enqueue_script('happyturtle-splash', get_template_directory_uri() . '/assets/splash.js', array(), '2.2.0', true);
    wp_localize_script('happyturtle-splash', 'htbData', array('themeUrl' => get_template_directory_uri()));
}
add_action('login_enqueue_scripts', 'happyturtle_login_scripts');

// Custom Login Page Styling
function happyturtle_login_styles() {
    ?>
    <style type="text/css">
        body.login {
            background: linear-gradient(135deg, #2D6A4F, #52B788, #40916C);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        body.login > * {
            position: static !important;
        }

        #login {
            width: auto;
            margin: 0;
            padding: 0;
        }

        #login h1 a {
            display: none;
        }

        .login-container-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
            max-width: 960px;
            margin: 2rem auto;
        }

        .login form {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(15, 36, 25, 0.19), 0 6px 6px rgba(212, 165, 116, 0.12);
            border: 1px solid rgba(212, 165, 116, 0.25);
            width: 100%;
            max-width: 400px;
        }

        .login form .input,
        .login input[type="text"],
        .login input[type="password"] {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(45, 106, 79, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login form .input:focus,
        .login input[type="text"]:focus,
        .login input[type="password"]:focus {
            border-color: #2D6A4F;
            box-shadow: 0 0 0 2px rgba(45, 106, 79, 0.1);
            outline: none;
        }

        .login .button-primary {
            background: linear-gradient(135deg, #1B4332, #2D6A4F, #D4A574);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 0 3px 6px rgba(15, 36, 25, 0.15), 0 2px 4px rgba(212, 165, 116, 0.1);
            transition: all 0.3s ease;
        }

        .login .button-primary:hover {
            background: linear-gradient(135deg, #0F2419, #1B4332, #B8854A);
            box-shadow: 0 10px 20px rgba(15, 36, 25, 0.19), 0 6px 6px rgba(212, 165, 116, 0.12);
            transform: translateY(-2px);
        }

        .login #backtoblog,
        .login #nav {
            background: transparent;
            padding: 0;
            margin-top: 1rem;
            text-align: center;
        }

        .login #backtoblog a,
        .login #nav a {
            color: #FFFFFF !important;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            transition: color 0.3s ease;
        }

        .login #backtoblog a:hover,
        .login #nav a:hover {
            color: #E8C9A0 !important;
        }

        .login .message,
        .login .success {
            border-left: 4px solid #2D6A4F;
            background: rgba(45, 106, 79, 0.1);
            border-radius: 8px;
        }

        /* Arkansas Compliance Notice */
        .login-compliance-notice {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.92));
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem;
            box-shadow: 0 4px 12px rgba(15, 36, 25, 0.2);
            border: 2px solid rgba(212, 165, 116, 0.4);
            width: 400px;
            height: 300px;
            overflow: hidden;
        }

        .login-compliance-notice h1.acc-title {
            color: #1B4332;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #D4A574;
            padding-bottom: 1rem;
        }

        .login-compliance-notice h2.b2b-description {
            color: #1e293b;
            font-size: 1rem;
            line-height: 1.6;
            text-align: center;
            margin: 0 0 1.5rem 0;
            font-weight: 500;
        }

        .login-compliance-notice ul {
            list-style: none;
            transition: all 0.3s ease;
            margin: 0 0 1.5rem 0;
        }

        .login-compliance-notice:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(15, 36, 25, 0.28), 0 4px 8px rgba(212, 165, 116, 0.2);
            margin: 0;
            padding: 0;
        }

        .login-compliance-notice li {
            color: #1e293b;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            padding-left: 0;
            text-align: center;
        }

        .login-compliance-notice .notice-footer {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(212, 165, 116, 0.4);
            text-align: center;
            font-size: 0.7rem;
            color: #1B4332;
            font-weight: 600;
        }
    </style>
    <?php
}
add_action('login_enqueue_scripts', 'happyturtle_login_styles');

// Change login logo URL
function happyturtle_login_logo_url() {
    return home_url();
}
add_filter('login_headerurl', 'happyturtle_login_logo_url');

// Change login logo title
function happyturtle_login_logo_url_title() {
    return 'Happy Turtle Processing, Inc.';
}
add_filter('login_headertext', 'happyturtle_login_logo_url_title');

// Add Arkansas Compliance Notice to Login Page
function happyturtle_login_compliance_notice() {
    ?>
    <div class="login-compliance-notice">
        <h1 class="acc-title">⚖️ Arkansas Cannabis Compliance</h1>
        <h2 class="b2b-description">THIS SYSTEM IS FOR LICENSED<br>ARKANSAS MEDICAL MARIJUANA DISPENSARIES<br>AND AUTHORIZED PERSONNEL ONLY</h2>
        <ul>
            <li>AR License #00340</li>
        </ul>
        <div class="notice-footer">
            Licensed Arkansas Medical Marijuana Processor<br>
            Hot Springs, AR
        </div>
    </div>
    <?php
}
add_action('login_footer', 'happyturtle_login_compliance_notice');

// Position compliance notice above login form
function happyturtle_login_layout_script() {
    ?>
    <style type="text/css">
        /* Hide login background during splash */
        body.login {
            background: transparent !important;
        }

        body.login.splash-complete {
            background: linear-gradient(135deg, #2D6A4F, #52B788, #40916C) !important;
            transition: background 0.5s ease;
        }

        /* Hide login content during splash */
        body.login #login,
        body.login #backtoblog,
        body.login #nav,
        body.login .login-compliance-notice {
            opacity: 0 !important;
            visibility: hidden !important;
        }

        body.login.splash-complete #login,
        body.login.splash-complete #backtoblog,
        body.login.splash-complete #nav,
        body.login.splash-complete .login-compliance-notice {
            opacity: 1 !important;
            visibility: visible !important;
            transition: opacity 1s ease !important;
        }

        /* Ensure splash screen covers everything on login page */
        body.login .htb-splash-screen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100vh !important;
            z-index: 99999 !important;
        }
    </style>
    <script type="text/javascript">
    // Clear splash screen flag to ensure it shows on login page
    sessionStorage.removeItem('htb-splash-shown');

    // Show login content after splash completes
    setTimeout(function() {
        document.body.classList.add('splash-complete');
    }, 5500);

    document.addEventListener('DOMContentLoaded', function() {
        // Setup compliance notice layout
        var loginDiv = document.getElementById('login');
        var complianceNotice = document.querySelector('.login-compliance-notice');

        if (loginDiv && complianceNotice) {
            var wrapper = document.createElement('div');
            wrapper.className = 'login-container-wrapper';

            loginDiv.parentNode.insertBefore(wrapper, loginDiv);
            wrapper.appendChild(complianceNotice);
            wrapper.appendChild(loginDiv);
        }
    });
    </script>
    <?php
}
add_action('login_footer', 'happyturtle_login_layout_script', 5);
